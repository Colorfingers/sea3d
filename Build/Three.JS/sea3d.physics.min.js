SEA3D.Sphere=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.radius=b.readFloat()};SEA3D.Sphere.prototype.type="sph";SEA3D.Box=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.width=b.readFloat();this.height=b.readFloat();this.depth=b.readFloat()};SEA3D.Box.prototype.type="box";SEA3D.Cone=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.radius=b.readFloat();this.height=b.readFloat()};SEA3D.Cone.prototype.type="cone";
SEA3D.Capsule=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.radius=b.readFloat();this.height=b.readFloat()};SEA3D.Capsule.prototype.type="cap";SEA3D.Cylinder=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.radius=b.readFloat();this.height=b.readFloat()};SEA3D.Cylinder.prototype.type="cyl";SEA3D.ConvexGeometry=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.geometry=c.getObject(b.readUInt());this.subGeometryIndex=b.readUByte()};SEA3D.ConvexGeometry.prototype.type="gs";
SEA3D.TriangleGeometry=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.geometry=c.getObject(b.readUInt());this.subGeometryIndex=b.readUByte()};SEA3D.TriangleGeometry.prototype.type="sgs";SEA3D.Compound=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.compounds=[];a=b.readUByte();for(var d=0;d<a;d++)this.compounds.push({shape:c.getObject(b.readUInt()),transform:b.readMatrix()})};SEA3D.Compound.prototype.type="cmps";
SEA3D.Physics=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.attrib=b.readUShort();this.shape=c.getObject(b.readUInt());this.attrib&1?this.target=c.getObject(b.readUInt()):this.transform=b.readMatrix()};SEA3D.Physics.prototype.readTag=function(a,b,c){};
SEA3D.RigidBodyBase=function(a,b,c){SEA3D.Physics.call(this,a,b,c);this.attrib&32?(this.linearDamping=b.readFloat(),this.angularDamping=b.readFloat()):this.angularDamping=this.linearDamping=0;this.mass=b.readFloat();this.friction=b.readFloat();this.restitution=b.readFloat()};SEA3D.RigidBodyBase.prototype=Object.create(SEA3D.Physics.prototype);SEA3D.RigidBodyBase.prototype.constructor=SEA3D.RigidBodyBase;SEA3D.RigidBody=function(a,b,c){SEA3D.RigidBodyBase.call(this,a,b,c);b.readTags(this.readTag.bind(this))};
SEA3D.RigidBody.prototype=Object.create(SEA3D.RigidBodyBase.prototype);SEA3D.RigidBody.prototype.constructor=SEA3D.RigidBody;SEA3D.RigidBody.prototype.type="rb";
SEA3D.CarController=function(a,b,c){SEA3D.RigidBodyBase.call(this,a,b,c);this.suspensionStiffness=b.readFloat();this.suspensionCompression=b.readFloat();this.suspensionDamping=b.readFloat();this.maxSuspensionTravelCm=b.readFloat();this.frictionSlip=b.readFloat();this.maxSuspensionForce=b.readFloat();this.dampingCompression=b.readFloat();this.dampingRelaxation=b.readFloat();a=b.readUByte();this.wheel=[];for(var d=0;d<a;d++)this.wheel[d]=new SEA3D.CarController.Wheel(b,c);b.readTags(this.readTag.bind(this))};
SEA3D.CarController.Wheel=function(a,b){this.data=a;this.sea3d=b;this.isFront=0!=(a.readUShort()&1);this.target=b.getObject(a.readUInt());this.pos=a.readVector3();this.dir=a.readVector3();this.axle=a.readVector3();this.radius=a.readFloat();this.suspensionRestLength=a.readFloat()};SEA3D.CarController.prototype=Object.create(SEA3D.RigidBodyBase.prototype);SEA3D.CarController.prototype.constructor=SEA3D.CarController;SEA3D.CarController.prototype.type="carc";
SEA3D.Constraints=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;this.attrib=b.readUShort();this.disableCollisionsBetweenBodies=this.attrib&1;this.targetA=c.getObject(b.readUInt());this.pointA=b.readVector3();this.attrib&2&&(this.targetB=c.getObject(b.readUInt()),this.pointB=b.readVector3())};SEA3D.P2PConstraint=function(a,b,c){this.name=a;this.data=b;this.sea3d=c;SEA3D.Constraints.call(this,a,b,c)};SEA3D.P2PConstraint.prototype=Object.create(SEA3D.Constraints.prototype);
SEA3D.P2PConstraint.prototype.constructor=SEA3D.P2PConstraint;SEA3D.P2PConstraint.prototype.type="p2pc";SEA3D.HingeConstraint=function(a,b,c){SEA3D.Constraints.call(this,a,b,c);this.axisA=b.readVector3();this.attrib&1&&(this.axisB=b.readVector3());this.attrib&4&&(this.limit={low:b.readFloat(),high:b.readFloat(),softness:b.readFloat(),biasFactor:b.readFloat(),relaxationFactor:b.readFloat()});this.attrib&8&&(this.angularMotor={velocity:b.readFloat(),impulse:b.readFloat()})};
SEA3D.HingeConstraint.prototype=Object.create(SEA3D.Constraints.prototype);SEA3D.HingeConstraint.prototype.constructor=SEA3D.HingeConstraint;SEA3D.HingeConstraint.prototype.type="hnec";SEA3D.ConeTwistConstraint=function(a,b,c){SEA3D.Constraints.call(this,a,b,c);this.axisA=b.readVector3();this.attrib&1&&(this.axisB=b.readVector3());this.attrib&4&&(this.limit={swingSpan1:b.readFloat(),swingSpan2:b.readFloat(),twistSpan:b.readFloat(),softness:b.readFloat(),biasFactor:b.readFloat(),relaxationFactor:b.readFloat()})};
SEA3D.ConeTwistConstraint.prototype=Object.create(SEA3D.Constraints.prototype);SEA3D.ConeTwistConstraint.prototype.constructor=SEA3D.ConeTwistConstraint;SEA3D.ConeTwistConstraint.prototype.type="ctwc";
SEA3D.File.setExtension(function(){this.addClass(SEA3D.Sphere);this.addClass(SEA3D.Box);this.addClass(SEA3D.Cone);this.addClass(SEA3D.Capsule);this.addClass(SEA3D.Cylinder);this.addClass(SEA3D.ConvexGeometry);this.addClass(SEA3D.TriangleGeometry);this.addClass(SEA3D.Compound);this.addClass(SEA3D.RigidBody);this.addClass(SEA3D.P2PConstraint);this.addClass(SEA3D.HingeConstraint);this.addClass(SEA3D.ConeTwistConstraint);this.addClass(SEA3D.CarController)});THREE.SEA3D.prototype.toAmmoVec3=function(a){return new Ammo.btVector3(a.x,a.y,a.z)};THREE.SEA3D.prototype.readSphere=function(a){var b=new Ammo.btSphereShape(a.radius);this.domain.shapes=this.shapes=this.shapes||[];this.shapes.push(this.objects["shpe/"+a.name]=a.tag=b)};THREE.SEA3D.prototype.readBox=function(a){var b=new Ammo.btBoxShape(new Ammo.btVector3(.5*a.width,.5*a.height,.5*a.depth));this.domain.shapes=this.shapes=this.shapes||[];this.shapes.push(this.objects["shpe/"+a.name]=a.tag=b)};
THREE.SEA3D.prototype.readCone=function(a){var b=new Ammo.btConeShape(a.radius,a.height);this.domain.shapes=this.shapes=this.shapes||[];this.shapes.push(this.objects["shpe/"+a.name]=a.tag=b)};THREE.SEA3D.prototype.readCylinder=function(a){var b=new Ammo.btCylinderShape(new Ammo.btVector3(a.height,a.radius,a.radius));this.domain.shapes=this.shapes=this.shapes||[];this.shapes.push(this.objects["shpe/"+a.name]=a.tag=b)};
THREE.SEA3D.prototype.readCapsule=function(a){var b=new Ammo.btCapsuleShape(a.radius,a.height);this.domain.shapes=this.shapes=this.shapes||[];this.shapes.push(this.objects["shpe/"+a.name]=a.tag=b)};
THREE.SEA3D.prototype.readConvexGeometry=function(a){if(this.config.convexHull)var b=THREE.AMMO.createConvexHull(a.geometry.tag,a.subGeometryIndex);else b=THREE.AMMO.createTriangleMesh(a.geometry.tag,a.subGeometryIndex),b=new Ammo.btConvexTriangleMeshShape(b,!0);this.domain.shapes=this.shapes=this.shapes||[];this.shapes.push(this.objects["shpe/"+a.name]=a.tag=b)};
THREE.SEA3D.prototype.readTriangleGeometry=function(a){var b=THREE.AMMO.createTriangleMesh(a.geometry.tag,a.subGeometryIndex),b=new Ammo.btBvhTriangleMeshShape(b,!0,!0);this.domain.shapes=this.shapes=this.shapes||[];this.shapes.push(this.objects["shpe/"+a.name]=a.tag=b)};
THREE.SEA3D.prototype.readCompound=function(a){for(var b=new Ammo.btCompoundShape,c=0;c<a.compounds.length;c++){var d=a.compounds[c];THREE.SEA3D.MTXBUF.elements=d.transform;var f=THREE.AMMO.getTransformFromMatrix(THREE.SEA3D.MTXBUF);b.addChildShape(f,d.shape.tag)}this.domain.shapes=this.shapes=this.shapes||[];this.shapes.push(this.objects["shpe/"+a.name]=a.tag=b)};
THREE.SEA3D.prototype.readRigidBodyBase=function(a){var b=a.shape.tag,c;a.target?c=THREE.AMMO.getTransformFromMatrix(a.target.tag.matrix):(THREE.SEA3D.MTXBUF.elements.set(a.transform),c=THREE.AMMO.getTransformFromMatrix(THREE.SEA3D.MTXBUF));c=new Ammo.btDefaultMotionState(c);var d=new Ammo.btVector3(0,0,0);b.calculateLocalInertia(a.mass,d);b=new Ammo.btRigidBodyConstructionInfo(a.mass,c,b,d);b.set_m_friction(a.friction);b.set_m_restitution(a.restitution);b.set_m_linearDamping(a.linearDamping);b.set_m_angularDamping(a.angularDamping);
b=new Ammo.btRigidBody(b);this.domain.rigidBodies=this.rigidBodies=this.rigidBodies||[];this.rigidBodies.push(this.objects["rb/"+a.name]=a.tag=b);return b};THREE.SEA3D.prototype.readRigidBody=function(a){var b=this.readRigidBodyBase(a);THREE.AMMO.addRigidBody(b,a.target?a.target.tag:void 0,a.offset?(new THREE.Matrix4).elements.set(a.offset):void 0,this.config.enabledPhysics)};
THREE.SEA3D.prototype.readCarController=function(a){var b=this.readRigidBodyBase(a);b.setActivationState(THREE.AMMO.DISABLE_DEACTIVATION);var c=new Ammo.btDefaultVehicleRaycaster(THREE.AMMO.world),d=new Ammo.btVehicleTuning;d.set_m_suspensionStiffness(a.suspensionStiffness);d.set_m_suspensionDamping(a.suspensionDamping);d.set_m_suspensionCompression(a.suspensionCompression);d.set_m_maxSuspensionTravelCm(a.maxSuspensionTravelCm);d.set_m_maxSuspensionForce(a.maxSuspensionForce);d.set_m_frictionSlip(a.frictionSlip);
var c=new Ammo.btRaycastVehicle(d,b,c),f=[];c.setCoordinateSystem(0,1,2);for(var g=0;g<a.wheel.length;g++){var e=a.wheel[g],h=c.addWheel(this.toAmmoVec3(e.pos),this.toAmmoVec3(e.dir),this.toAmmoVec3(e.axle),e.suspensionRestLength,e.radius,d,e.isFront);if(e=f[g]=e.target?e.target.tag:void 0)e.parent&&e.parent.remove(e),this.container&&this.container.add(e);h.set_m_suspensionStiffness(a.suspensionStiffness);h.set_m_wheelsDampingRelaxation(a.dampingRelaxation);h.set_m_wheelsDampingCompression(a.dampingCompression);
h.set_m_frictionSlip(a.frictionSlip)}THREE.AMMO.addVehicle(c,f);THREE.AMMO.addRigidBody(b,a.target?a.target.tag:void 0,a.offset?(new THREE.Matrix4).elements.set(a.offset):void 0,this.config.enabledPhysics);this.domain.vehicles=this.vehicles=this.vehicles||[];this.vehicles.push(this.objects["vhc/"+a.name]=a.tag=c)};
THREE.SEA3D.prototype.readP2PConstraint=function(a){var b;b=a.targetB?new Ammo.btPoint2PointConstraint(a.targetA.tag,a.targetB.tag,this.toAmmoVec3(a.pointA),this.toAmmoVec3(a.pointB)):new Ammo.btPoint2PointConstraint(a.targetA.tag,this.toAmmoVec3(a.pointA));THREE.AMMO.addConstraint(b);this.domain.constraints=this.constraints=this.constraints||[];this.constraints.push(this.objects["ctnt/"+a.name]=a.tag=b)};
THREE.SEA3D.prototype.readHingeConstraint=function(a){var b;b=a.targetB?new Ammo.btHingeConstraint(a.targetA.tag,a.targetB.tag,this.toAmmoVec3(a.pointA),this.toAmmoVec3(a.pointB),this.toAmmoVec3(a.axisA),this.toAmmoVec3(a.axisB),!1):new Ammo.btHingeConstraint(a.targetA.tag,this.toAmmoVec3(a.pointA),this.toAmmoVec3(a.axisA),!1);a.limit&&b.setLimit(a.limit.low,a.limit.high,a.limit.softness,a.limit.biasFactor,a.limit.relaxationFactor);a.angularMotor&&b.enableAngularMotor(!0,a.angularMotor.velocity,a.angularMotor.impulse);
THREE.AMMO.addConstraint(b);this.domain.constraints=this.constraints=this.constraints||[];this.constraints.push(this.objects["ctnt/"+a.name]=a.tag=b)};
THREE.SEA3D.prototype.readConeTwistConstraint=function(a){var b;b=a.targetB?new Ammo.btConeTwistConstraint(a.targetA.tag,a.targetB.tag,this.toAmmoVec3(a.pointA),this.toAmmoVec3(a.pointB),!1):new Ammo.btConeTwistConstraint(a.targetA.tag,this.toAmmoVec3(a.pointA),!1);THREE.AMMO.addConstraint(b);this.domain.constraints=this.constraints=this.constraints||[];this.constraints.push(this.objects["ctnt/"+a.name]=a.tag=b)};
THREE.SEA3D.Domain.prototype.enabledPhysics=function(a){for(var b=this.rigidBodies?this.rigidBodies.length:0;b--;)THREE.AMMO.setEnabledRigidBody(this.rigidBodies[b],a)};THREE.SEA3D.Domain.prototype.applyContainerTransform=function(){this.container.updateMatrix();var a=this.container.matrix.clone();this.container.position.set(0,0,0);this.container.rotation.set(0,0,0);this.container.scale.set(1,1,1);this.applyTransform(a)};
THREE.SEA3D.Domain.prototype.applyTransform=function(a){for(var b=THREE.SEA3D.MTXBUF,c=THREE.SEA3D.VECBUF,d=this.rigidBodies?this.rigidBodies.length:0,f=this.container?this.container.children:[],g=[];d--;){var e=this.rigidBodies[d],h=THREE.AMMO.getTargetByRigidBody(e),k=e.getWorldTransform(),k=THREE.AMMO.getMatrixFromTransform(k);k.multiplyMatrices(k,a);k=THREE.AMMO.getTransformFromMatrix(k);e.setWorldTransform(k);h&&g.push(h)}for(d=0;d<f.length;d++)e=f[d],-1<g.indexOf(e)||(e.updateMatrix(),b.copy(e.matrix),
b.multiplyMatrices(a,b),e.position.setFromMatrixPosition(b),e.scale.setFromMatrixScale(b),b.scale(c.set(1/e.scale.x,1/e.scale.y,1/e.scale.z)),e.rotation.setFromRotationMatrix(b))};THREE.SEA3D.Domain.prototype.getShape=THREE.SEA3D.prototype.getShape=function(a){return this.objects["shpe/"+a]};THREE.SEA3D.Domain.prototype.getRigidBody=THREE.SEA3D.prototype.getRigidBody=function(a){return this.objects["rb/"+a]};
THREE.SEA3D.Domain.prototype.getConstraint=THREE.SEA3D.prototype.getConstraint=function(a){return this.objects["ctnt/"+a]};
THREE.SEA3D.EXTENSIONS_LOADER.push({parse:function(){delete this.shapes;delete this.rigidBodies;delete this.vehicles;delete this.constraints},setTypeRead:function(){this.config.physics=void 0!==this.config.physics?this.config.physics:!0;this.config.convexHull=void 0!==this.config.convexHull?this.config.convexHull:!0;this.config.enabledPhysics=void 0!==this.config.enabledPhysics?this.config.enabledPhysics:!0;this.config.physics&&(this.file.typeRead[SEA3D.Sphere.prototype.type]=this.readSphere,this.file.typeRead[SEA3D.Box.prototype.type]=
this.readBox,this.file.typeRead[SEA3D.Capsule.prototype.type]=this.readCapsule,this.file.typeRead[SEA3D.Cone.prototype.type]=this.readCone,this.file.typeRead[SEA3D.Cylinder.prototype.type]=this.readCylinder,this.file.typeRead[SEA3D.ConvexGeometry.prototype.type]=this.readConvexGeometry,this.file.typeRead[SEA3D.TriangleGeometry.prototype.type]=this.readTriangleGeometry,this.file.typeRead[SEA3D.Compound.prototype.type]=this.readCompound,this.file.typeRead[SEA3D.P2PConstraint.prototype.type]=this.readP2PConstraint,
this.file.typeRead[SEA3D.HingeConstraint.prototype.type]=this.readHingeConstraint,this.file.typeRead[SEA3D.ConeTwistConstraint.prototype.type]=this.readConeTwistConstraint,this.file.typeRead[SEA3D.RigidBody.prototype.type]=this.readRigidBody,this.file.typeRead[SEA3D.CarController.prototype.type]=this.readCarController)}});
THREE.SEA3D.EXTENSIONS_DOMAIN.push({dispose:function(){var a;for(a=this.rigidBodies?this.rigidBodies.length:0;a--;)THREE.AMMO.removeRigidBody(this.rigidBodies[a],!0);for(a=this.vehicles?this.vehicles.length:0;a--;)THREE.AMMO.removeVehicle(this.vehicles[a],!0);for(a=this.constraints?this.constraints.length:0;a--;)THREE.AMMO.removeConstraint(this.constraints[a],!0);for(a=this.shapes?this.shapes.length:0;a--;)Ammo.destroy(this.shapes[a])}});
